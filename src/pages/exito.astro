---
import Layout from "../layouts/Layout.astro";
import Stripe from "stripe";
import nodemailer from "nodemailer";

const sessionId = Astro.url.searchParams.get('session_id');
let customerEmail = '';
let productName = 'Servicio';

if (sessionId) {
  const stripe = new Stripe(import.meta.env.STRIPE_SECRET_KEY);
  
  try {
    const session = await stripe.checkout.sessions.retrieve(sessionId, {
      expand: ['line_items']
    });
    
    customerEmail = session.customer_details?.email || '';
    const customerName = session.customer_details?.name || 'Cliente';
    
    // Obtener el nombre del producto
    const lineItem = session.line_items?.data[0];
    if (lineItem && lineItem.description) {
      productName = lineItem.description;
    } else if (lineItem && lineItem.price && lineItem.price.product) {
       // Fallback si la descripción no está directa (aunque en checkout se pasa como name/description)
       // En checkout.ts: product_data: { name: "..." } se mapea a description en line_item a veces o price.product
       // Stripe API: line_item.description suele ser el product name.
       productName = lineItem.description || 'Servicio Premium';
    }

    // Normalizar el nombre para comparaciones si es necesario, 
    // pero usaremos el valor directo para el correo.
    
    const amountTotal = session.amount_total ? (session.amount_total / 100).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' }) : '';
    
    // Obtener fecha y hora actual en CDMX
    const now = new Date();
    const purchaseDate = now.toLocaleDateString('es-MX', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      timeZone: 'America/Mexico_City'
    });
    const purchaseTime = now.toLocaleTimeString('es-MX', { 
      hour: '2-digit', 
      minute: '2-digit',
      timeZone: 'America/Mexico_City'
    });

    // Enviar correo si tenemos el email
    if (customerEmail) {
      const transporter = nodemailer.createTransport({
        host: import.meta.env.SMTP_HOST,
        port: Number(import.meta.env.SMTP_PORT),
        secure: false, 
        auth: {
          user: import.meta.env.SMTP_USER,
          pass: import.meta.env.SMTP_PASS,
        },
      });

      const mailOptions = {
        from: `"Pequeños Momentos" <${import.meta.env.SMTP_USER}>`,
        to: customerEmail,
        bcc: import.meta.env.SMTP_USER,
        subject: `Confirmación de ${productName} - Pequeños Momentos`,
        html: `
          <div style="font-family: Arial, sans-serif; color: #333; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #6b46c1;">¡Gracias por tu compra, ${customerName}!</h1>
            <p>Hemos recibido tu pago para la <strong>${productName}</strong> exitosamente.</p>
            <p>Estamos emocionados de poder ayudarte a impulsar tu proyecto.</p>
            <hr style="border: 1px solid #eee; margin: 20px 0;">
            <h3>Detalles de tu compra:</h3>
            <ul>
              <li><strong>Servicio:</strong> ${productName}</li>
              <li><strong>Costo:</strong> ${amountTotal}</li>
              <li><strong>Fecha:</strong> ${purchaseDate}</li>
              <li><strong>Hora:</strong> ${purchaseTime}</li>
              <li><strong>Referencia:</strong> ${sessionId}</li>
            </ul>
            <p>Pronto nos pondremos en contacto contigo para agendar tu sesión.</p>
            <p>Si tienes alguna duda, puedes responder a este correo.</p>
            <br>
            <p>Atentamente,<br>El equipo de Pequeños Momentos</p>
          </div>
        `,
      };

      try {
        await transporter.sendMail(mailOptions);
        console.log(`Correo enviado a ${customerEmail}`);
      } catch (emailError) {
        console.error("Error enviando correo:", emailError);
      }
    }
  } catch (error) {
    console.error("Error recuperando sesión de Stripe:", error);
  }
}
---

<Layout>
  <main class="min-h-screen flex items-center justify-center bg-gradient-to-b from-purple-100 to-white px-4">
    <div class="max-w-xl w-full bg-white rounded-xl shadow-2xl p-8 text-center space-y-6">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto">
        <span class="text-4xl">✅</span>
      </div>
      
      <h1 class="text-3xl font-bold text-gray-800">¡Pago Exitoso!</h1>
      
      <p class="text-gray-600">
        Gracias por tu compra de <strong>{productName}</strong>. Hemos recibido tu pago correctamente.
        {sessionId && <span class="block text-xs text-gray-400 mt-2">ID de referencia: {sessionId}</span>}
      </p>

      <div class="bg-purple-50 p-4 rounded-lg">
        <p class="text-sm text-purple-800 font-medium">
          Te hemos enviado un correo con los detalles de tu servicio y los pasos a seguir
          {customerEmail && <span> a <strong>{customerEmail}</strong></span>}.
        </p>
      </div>

      <a
        href="/"
        class="block w-full py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors duration-300"
      >
        Volver al Inicio
      </a>
    </div>
  </main>
</Layout>
